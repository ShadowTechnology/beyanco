<div
  class="page"
  (click)="mobileSidebarOpen = false"
  [class.modal-open]="showPopup || showImagePopup">
  <!-- Sidebar -->
  <aside
    class="sidebar"
    [class.open]="mobileSidebarOpen"
    [class.collapsed]="sidebarCollapsed"
    (click)="$event.stopPropagation()">

    <div class="logo">
      <ng-container *ngIf="!sidebarCollapsed">
        <i class="fa-solid fa-comment"></i>
        <span>Beyanco AI Chat</span>
      </ng-container>
      <!-- <i class="fa fa-comment"></i>
      <span *ngIf="!sidebarCollapsed">Beyanco AI Chat</span> -->
      <button class="collapse-btn" (click)="toggleSidebar()">
        <i class="fa-solid"
          [ngClass]="!isSidebarExpanded() ? 'fa-chevron-right' : 'fa-chevron-left'"></i>
      </button>
    </div>
    <button
      class="new-chat-btn1"
      *ngIf="!isSidebarExpanded()"
      (click)="newChat()">
      <i class="fa-solid fa-plus"></i>
    </button>
    <button
      class="new-chat-btn"
      *ngIf="isSidebarExpanded()"
      (click)="newChat()">
      <i class="fa-solid fa-plus"></i>
      <span>New Chat</span>
    </button>

    <div class="divider"></div>

    <p class="section-label" *ngIf="isSidebarExpanded()">Recent Chats</p>

    <!-- <div class="history-list" *ngIf="conversationsList.length; else noHistory">
      <button *ngFor="let conv of conversationsList;" class="history-item"
        (click)="openConversation(conv.id)">
        <i class="fa fa-message"></i>
        <div class="history-content">
          <div class="history-title">{{ conv.title }}</div>
        </div>
      </button>
    </div> -->
    <div class="history-list" *ngIf="isSidebarExpanded()">
      <ng-container
        *ngFor="let group of groupedConversations | keyvalue: dateOrder">

        <button *ngFor="let conv of group.value" class="history-item"
          (click)="openConversation(conv.id)">
          <div class="history-title">
            {{ conv.title || 'New Design' }}
          </div>
        </button>

      </ng-container>
    </div>

    <ng-template #noHistory>
      <div class="no-history">No chat history found</div>
    </ng-template>

    <ng-template #noHistory>
      <div class="empty-state" *ngIf="sidebarCollapsed">
        <i class="fa-solid fa-inbox"></i>
        <p>No conversations yet</p>
      </div>
    </ng-template>

    <div class="sidebar-footer">
      <button
        class="footer-btn"
        *ngIf="!isSidebarExpanded()"
        (click)="goToProfile()"
        title="Profile">
        <i class="fa-solid fa-circle-user"></i>
      </button>

      <button
        class="footer-btn"
        *ngIf="isSidebarExpanded()"
        (click)="goToProfile()"
        title="Profile">
        <i class="fa-solid fa-circle-user"></i>
        <span>Profile</span>
      </button>

      <!-- <button class="footer-btn" title="Settings">
        <i class="fa fa-cog"></i>
        <span *ngIf="!sidebarCollapsed">Settings</span>
      </button> -->
    </div>
  </aside>

  <!-- Main Chat Area -->
  <main class="chat-main">

    <div class="message-container">
      <button
        class="chat-sidebar-btn mobile-only"
        (click)="toggleChatSidebar($event)"
        aria-label="Open chat sidebar">
        <img src="assets/sidebar.png" alt="Open Sidebar" />
      </button>
      <!-- Messages Container -->
      <div class="messages-container" #scrollArea>
        <ng-container
          *ngIf="hasActiveConversation || isUploading || isLoadingChat || messages().length; else welcomeScreen">
          <div *ngFor="let msg of messages(); trackBy: trackById"
            class="message-wrapper"
            [class.user-message]="msg.role === 'user'"
            [class.assistant-message]="msg.role === 'assistant'">

            <div class="message-content">
              <div class="avatar">
                <i class="fa-solid"
                  [ngClass]="msg.role === 'user' ? 'fa-user' : 'fa-robot'"></i>
              </div>

              <div class="message-body">
                <!-- <div class="message-text" *ngIf="msg.text">{{ msg.text
                }}</div> -->

                <div class="message-images" *ngIf="msg.images?.length">
                  <img *ngFor="let img of msg.images" [src]="img" alt="Image"
                    class="message-image"
                    (click)="selectImage(img, $event)" />
                </div>
                <div
                  class="message-description-text"
                  *ngIf="msg.text">
                  {{ msg.text
                  }}
                </div>
                <div class="message-meta" *ngIf="msg.room || msg.style">
                  <span class="meta-tag" *ngIf="msg.room">
                    <i class="fa fa-door-open"></i> {{ msg.room }}
                  </span>
                  <span class="meta-tag" *ngIf="msg.style">
                    <i class="fa fa-palette"></i> {{ msg.style }}
                  </span>
                </div>

                <div class="message-time">{{ msg.timestamp | date:'short'
                  }}</div>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-template #welcomeScreen>
          <div *ngIf="!hasActiveConversation" class="welcome-screen">
            <div class="welcome-icon">
              <i class="fa fa-comments"></i>
            </div>
            <h2>Welcome to Beyanco AI Chat</h2>
            <p>Upload an image, select a room, and describe your vision. Our AI
              will bring it to life.</p>

            <div class="quick-actions">
              <button class="quick-action-btn" (click)="openUploadPopup()">
                <i class="fa fa-upload"></i>
                <span>Upload Image</span>
              </button>
              <button class="quick-action-btn" (click)="openUploadPopup()">
                <i class="fa fa-home"></i>
                <span>Select Room</span>
              </button>
            </div>
          </div>
        </ng-template>

      </div>
      <!-- Generated Property Chat Messages -->
      <div class="messages-container-generated" *ngIf="properties.length > 0">
        <ng-container>
          <div *ngFor="let p of properties">

            <div class="message-wrapper user-message">
              <div class="message-content">
                <div class="avatar">
                  <i class="fa fa-user"></i>
                </div>

                <div class="message-body">
                  <!-- <div class="message-text">
                  {{ p.title }}
                </div> -->

                  <div class="message-images" *ngIf="p.originalImageUrl">
                    <img [src]="p.originalImageUrl" alt="Original Design"
                      class="message-image"
                      (click)="selectImage(p.originalImageUrl, $event)" />
                  </div>
                  <div
                    class="message-title"
                    *ngIf="p.title">
                    {{ p.title }}
                  </div>
                  <div class="message-meta">
                    <span class="meta-tag">
                      <i class="fa fa-door-open"></i> {{ p.propertyType }}
                    </span>
                    <span class="meta-tag" *ngIf="p.enhancementStyle">
                      <i class="fa fa-palette"></i> {{ p.enhancementStyle }}
                    </span>
                  </div>

                  <div class="message-time">
                    {{ p.createdAt | date:'short' }}
                  </div>
                </div>
              </div>
            </div>

            <div class="message-wrapper assistant-message">
              <div class="message-content">
                <div class="avatar">
                  <i class="fa fa-robot"></i>
                </div>

                <div class="message-body">
                  <div class="message-text">
                    Generated Design for <strong>{{ p.propertyType }}</strong>
                  </div>
                  <div class="message-images" *ngIf="p.generatedImageUrl">
                    <img [src]="p.generatedImageUrl" alt="Generated Design"
                      class="message-image"
                      (click)="selectImage(p.generatedImageUrl, $event)" />
                  </div>
                  <div
                    class="message-description"
                    *ngIf="p.description">
                    {{ p.description }}
                  </div>
                  <div class="message-meta">
                    <span class="meta-tag">
                      <i class="fa fa-door-open"></i> {{ p.propertyType }}
                    </span>
                    <span class="meta-tag" *ngIf="p.enhancementStyle">
                      <i class="fa fa-palette"></i> {{ p.enhancementStyle }}
                    </span>
                  </div>

                  <div class="message-time">
                    {{ p.createdAt | date:'short' }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>

      <div class="loading-indicator" *ngIf="isUploading">
        <div class="spinner"></div>
        <span>Generating your design...</span>
      </div>
    </div>
    <!-- Input Composer -->
    <div class="composer-container">
      <div class="composer-container">
        <div class="composer-wrapper">

          <div class="composer-input">

            <!-- Image preview (LEFT of textarea) -->
            <div class="inline-image-preview" *ngIf="pendingImages().length">
              <img [src]="pendingImages()[0]" />
              <button class="remove-img" (click)="removePendingImage(0)">
                ✕
              </button>
            </div>

            <!-- Textarea -->
            <textarea
              [(ngModel)]="composerDescription"
              class="composer-textarea"
              placeholder="Describe your vision..."
              rows="1"
              (keydown)="onEnterKey($event)"
              #textareaRef>
      </textarea>

            <!-- Actions -->
            <div class="composer-actions">

              <!-- ➕ Add button -->
              <button class="action-btn" (click)="toggleAddMenu($event)">
                <img src="assets/add-button.png" class="add-btn" />
              </button>

              <!-- Add menu -->
              <div class="add-menu" *ngIf="showAddMenu">
                <button (click)="triggerFileInput()">
                  <i class="fa fa-image"></i> Add Photo
                </button>
              </div>

              <!-- Hidden file input -->
              <input
                #fileInput
                type="file"
                accept="image/*"
                hidden
                (change)="onFiles($event)" />

              <!-- Send -->
              <button
                class="action-btn send-btn"
                (click)="send()"
                [disabled]="!canSend()">
                <i class="fa fa-paper-plane"></i>
              </button>

            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Setup Popup -->
  <div class="modal-overlay" *ngIf="showPopup" (click)="closePopup()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Setup Your Project</h2>
        <button class="close-modal-btn" (click)="closePopup()">
          <i class="fa fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <!-- Upload Area -->
        <div class="upload-area" *ngIf="!pendingImages().length">
          <label class="upload-label">
            <i class="fa fa-cloud-upload-alt"></i>
            <span>Click to upload or drag & drop</span>
            <small>PNG, JPG up to 10MB</small>
            <input type="file" accept="image/*" multiple
              (change)="onFiles($event)" hidden>
          </label>
        </div>

        <!-- Preview Grid -->
        <div class="preview-grid" *ngIf="pendingImages().length">
          <div class="preview-card"
            *ngFor="let img of pendingImages(); let i = index">
            <img [src]="img" alt="Preview">
            <button class="remove-btn" (click)="removePendingImage(i)">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group half">
            <label>Room Type</label>
            <select [(ngModel)]="roomModel" class="form-select">
              <option value>Select room...</option>
              <option *ngFor="let room of rooms" [value]="room">{{ room
                }}</option>
            </select>
          </div>

          <div class="form-group half">
            <label>Style Theme</label>
            <select [(ngModel)]="style" class="form-select">
              <option value>Select style...</option>
              <option *ngFor="let s of StyleTags" [value]="s">{{ s }}</option>
            </select>
          </div>
        </div>

        <!-- <div class="form-group">
          <label>House Style</label>
          <select [(ngModel)]="Housestyle" class="form-select">
            <option value>Select house style...</option>
            <option *ngFor="let hs of HouseStyleTags" [value]="hs">{{ hs
              }}</option>
          </select>
        </div> -->

        <div class="form-group" style="margin: 0;">
          <label>Description</label>
          <textarea [(ngModel)]="popupDescription" class="form-textarea"
            placeholder="I want a mordern living room with ambient sunlight..."
            rows="3"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closePopup()">Cancel</button>
        <button class="btn btn-primary" (click)="confirmPopup()">Start
          Chat</button>
      </div>
    </div>
  </div>

  <!-- Image Viewer Modal -->
  <div class="modal-overlay" *ngIf="showImagePopup && currentImage"
    (click)="closeImagePopup()">
    <div class="modal-content image-modal" (click)="$event.stopPropagation()">
      <!-- Toolbar -->
      <div class="image-toolbar">
        <div class="toolbar-left">
          <button class="toolbar-btn" (click)="undo()" title="Undo">
            <i class="fa fa-undo"></i>
          </button>
          <button class="toolbar-btn" (click)="redo()" title="Redo">
            <i class="fa fa-redo"></i>
          </button>

          <select [(ngModel)]="selectedTool" (change)="openTool(selectedTool)"
            class="tool-select">
            <option value disabled hidden>Select</option>
            <option *ngFor="let tool of tools" [value]="tool">{{ tool
              }}</option>
          </select>
        </div>

        <div class="toolbar-right">
          <button class="toolbar-btn" (click)="likeImage()" title="Like">
            <i class="fa fa-thumbs-up"></i>
          </button>
          <button class="toolbar-btn" (click)="dislikeImage()" title="Dislike">
            <i class="fa fa-thumbs-down"></i>
          </button>
          <button class="toolbar-btn" (click)="downloadImage()"
            title="Download">
            <i class="fa fa-download"></i>
          </button>
          <button class="toolbar-btn" (click)="shareImage()" title="Share">
            <i class="fa fa-share-alt"></i>
          </button>
          <button class="toolbar-btn close-btn" (click)="closeImagePopup()">
            <i class="fa fa-times"></i>
          </button>
        </div>
      </div>

      <!-- Tool Panels -->
      <div class="tool-panel" *ngIf="activeTool === 'Magic Eraser'">
        <h3><i class="fa fa-eraser"></i> Magic Eraser</h3>
        <p>Remove unwanted objects and clean up your image automatically.</p>
        <div class="tool-actions">
          <button class="btn btn-primary" (click)="applyEraser()">
            <i class="fa fa-magic"></i> Apply Magic Eraser
          </button>
          <!-- <button class="btn btn-secondary"
            (click)="closeTool()">Cancel</button> -->
        </div>
      </div>
      <div class="tool-panel" *ngIf="activeTool === 'Compare Version'">
        <h3><i class="fa fa-columns"></i> Compare Images</h3>

        <!-- Thumbnail Strip with Load More -->
        <div class="thumbnail-strip">
          <div class="thumb"
            *ngFor="let img of visibleThumbnails; let i = index"
            draggable="true"
            (dragstart)="onDragStart($event, img)">
            <img [src]="img" alt="Thumbnail" />
            <button class="remove-btn" (click)="removeCompareImage(i, $event)">
              <i class="fa fa-times"></i>
            </button>
          </div>

          <div class="load-more"
            *ngIf="compareThumbnails().length > visibleThumbnails.length">
            <button (click)="loadMoreThumbnails()">Load More</button>
          </div>

          <div class="no-thumbs" *ngIf="compareThumbnails().length === 0">
            No images yet
          </div>
        </div>

        <!-- Dropdown for number of boxes -->
        <div class="compare-box-selector">
          <label style="margin: 0;">Number of comparison boxes:</label>
          <select class="dropdown-count" [(ngModel)]="numCompareBoxes">
            <option *ngFor="let n of [2,4,6]" [value]="n">{{n}}</option>
          </select>
        </div>
        <!-- Orientation buttons -->
        <div class="compare-mode-selector">
          <button class="mode-btn" [class.active]="compareMode === 'horizontal'"
            (click)="setCompareMode('horizontal')">
            <i class="fa fa-grip-lines-vertical"></i> Horizontal
          </button>
          <button class="mode-btn" [class.active]="compareMode === 'vertical'"
            (click)="setCompareMode('vertical')">
            <i class="fa fa-grip-lines"></i> Vertical
          </button>
        </div>
        <!-- Comparison Area -->
        <div class="comparison-container"
          [class.horizontal]="compareMode === 'horizontal'"
          [class.vertical]="compareMode === 'vertical'">

          <div class="comparison-side"
            *ngFor="let box of compareBoxes; let i = index"
            (drop)="onDrop($event, i)"
            (dragover)="onDragOver($event)">

            <div class="comparison-label">Box {{i+1}}</div>
            <img *ngIf="box" [src]="box" alt="Comparison" />
            <div class="no-image" *ngIf="!box">Drop image here</div>
          </div>
        </div>

        <!-- <div class="tool-actions">
          <button class="btn btn-secondary" (click)="closeTool()">Close</button>
        </div> -->
      </div>

      <!-- <div class="tool-panel" *ngIf="activeTool === 'Compare Version'">
        <h3><i class="fa fa-columns"></i> Compare Images</h3>

        <div class="compare-mode-selector">
          <button class="mode-btn" [class.active]="compareMode === 'horizontal'" (click)="setCompareMode('horizontal')">
            <i class="fa fa-grip-lines-vertical"></i> Horizontal
          </button>
          <button class="mode-btn" [class.active]="compareMode === 'vertical'" (click)="setCompareMode('vertical')">
            <i class="fa fa-grip-lines"></i> Vertical
          </button>
        </div>

        <div class="comparison-container" [class.horizontal]="compareMode === 'horizontal'"
          [class.vertical]="compareMode === 'vertical'">
          <div class="comparison-side">
            <div class="comparison-label">Original</div>
            <img [src]="currentOriginalImage" *ngIf="currentOriginalImage" alt="Original">
            <div class="no-image" *ngIf="!currentOriginalImage">No original
              image</div>
          </div>
          <div class="comparison-side">
            <div class="comparison-label">Generated</div>
            <img [src]="currentGeneratedImage" *ngIf="currentGeneratedImage" alt="Generated">
            <div class="no-image" *ngIf="!currentGeneratedImage">No generated
              image</div>
          </div>
        </div>

        <div class="tool-actions">
          <button class="btn btn-secondary" (click)="closeTool()">Close</button>
        </div>
      </div> -->

      <div class="tool-panel" *ngIf="activeTool === 'Add Element'">
        <h3><i class="fa fa-plus-circle"></i> Add Element</h3>
        <p>Select an element to enhance your design:</p>

        <div class="element-grid">
          <button *ngFor="let el of elements" class="element-card"
            [class.selected]="selectedElement === el.name"
            (click)="selectedElement = el.name">
            <i class="fa fa-lightbulb" *ngIf="el.name === 'Add Lighting'"></i>
            <i class="fa fa-leaf" *ngIf="el.name === 'Add Plants'"></i>
            <i class="fa fa-couch" *ngIf="el.name === 'Add Furniture'"></i>
            <i class="fa fa-image" *ngIf="el.name === 'Add Artwork'"></i>
            <i class="fa fa-th-large" *ngIf="el.name === 'Add Rug'"></i>
            <i class="fa fa-window-maximize"
              *ngIf="el.name === 'Add Curtains'"></i>
            <span>{{ el.name }}</span>
          </button>
        </div>

        <div class="element-description" *ngIf="selectedElement">
          <strong>Prompt:</strong> {{ getElementPrompt(selectedElement) }}
        </div>

        <div class="tool-actions">
          <button class="btn btn-primary" (click)="applyElement()"
            [disabled]="!selectedElement">
            <i class="fa fa-check"></i> Apply Element
          </button>
          <!-- <button class="btn btn-secondary"
            (click)="closeTool()">Cancel</button> -->
        </div>
      </div>

      <!-- Image Display -->
      <div class="image-display" *ngIf="!activeTool">
        <img [src]="currentImage" alt="Full size preview">
      </div>
    </div>
  </div>
</div>
<!-- MOBILE FAB TOGGLE -->
<!-- <button
  class="mobile-fab"
  (click)="toggleMobileSidebar()"
  aria-label="Toggle Menu">
  <i class="fa-solid"
    [ngClass]="mobileSidebarOpen ? 'fa-xmark' : 'fa-comment'"></i>
</button> -->
<!-- BACKDROP -->
<div class="credit-backdrop" *ngIf="showCreditPopup"
  (click)="closeCreditPopup()">

  <!-- MODAL BOX -->
  <div class="credit-modal" (click)="$event.stopPropagation()">
    <h2>Credit Limit Reached</h2>
    <p>You have no credits left. Please upgrade your plan.</p>

    <button class="close-btn" (click)="closeCreditPopup()">Close</button>
  </div>

</div>