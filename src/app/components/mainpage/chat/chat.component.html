<div
  class="page"
  [class.modal-open]="showPopup || showImagePopup">
  <!-- Sidebar -->
  <aside
    #chatSidebar
    class="sidebar"
    [class.open]="mobileSidebarOpen"
    [class.collapsed]="sidebarCollapsed"
    (click)="$event.stopPropagation()">

    <div class="logo">
      <ng-container *ngIf="!sidebarCollapsed">
        <span class="fa-solid fa-comment"
          style="color: #facc15; margin-right: 10px;"></span>
        <span>Beyanco AI Chat</span>
      </ng-container>
      <!-- <span class="fa-solid fa-comment"></span>
      <span *ngIf="!sidebarCollapsed">Beyanco AI Chat</span> -->
      <button class="collapse-btn" (click)="toggleSidebar()">
        <span class="fa-solid"
          [ngClass]="!isSidebarExpanded() ? 'fa-chevron-right' : 'fa-chevron-left'"
          style="opacity: 1;color: #facc15; margin-right: 10px;"></span>
      </button>
    </div>
    <button
      class="new-chat-btn1"
      *ngIf="!isSidebarExpanded()"
      (click)="newChat()">
      <span class="fa-solid fa-plus"></span>
    </button>
    <button
      class="new-chat-btn"
      *ngIf="isSidebarExpanded()"
      (click)="newChat($event)">
      <span class="fa-solid fa-plus"></span>
      <span>New Chat</span>
    </button>

    <div class="divider"></div>

    <p class="section-label" *ngIf="isSidebarExpanded()">Recent Chats</p>

    <!-- <div class="history-list" *ngIf="conversationsList.length; else noHistory">
      <button *ngFor="let conv of conversationsList;" class="history-item"
        (click)="openConversation(conv.id)">
        <span class="fa-solid fa-message"></span>
        <div class="history-content">
          <div class="history-title">{{ conv.title }}</div>
        </div>
      </button>
    </div> -->
    <div class="history-list" *ngIf="isSidebarExpanded()">
      <ng-container
        *ngFor="let group of groupedConversations | keyvalue: dateOrder">

        <button
          *ngFor="let conv of group.value"
          class="history-item"
          [class.active]="activeConversationId() === conv.id"
          [class.menu-open]="activeMenuId === conv.id"
          (click)="openConversation(conv.id)">

          <div class="history-title">
            {{ conv.title || 'New Design' }}
          </div>

          <div class="flex-right" (click)="$event.stopPropagation()">
            <span
              class="fa-solid fa-ellipsis ellipsis-icon"
              (click)="toggleMenu(conv.id)">
            </span>

            <!-- Context Menu -->
            <div
              class="menu-card"
              *ngIf="activeMenuId === conv.id">

              <div class="menu-item" (click)="openRenamePopup(conv)">
                <span class="fa-solid fa-pen"></span> Rename
              </div>

              <!-- <div class="menu-item" (click)="pinChat(conv)">
                <span class="fa-solid fa-map-pin"></span> Pin chat
              </div> -->

              <div class="menu-item danger" (click)="openDeletePopup(conv)">
                <span class="fas fa-trash-alt"></span> Delete
              </div>
            </div>
          </div>

        </button>

      </ng-container>
    </div>

    <!-- <div class="history-list" *ngIf="isSidebarExpanded()">
      <ng-container
        *ngFor="let group of groupedConversations | keyvalue: dateOrder">

        <button *ngFor="let conv of group.value" class="history-item"
          (click)="openConversation(conv.id)">
          <div class="history-title">
            {{ conv.title || 'New Design' }}
          </div>
          <div class="flex-right"><span class="fa-solid fa-ellipsis"></span></div>
        </button>

      </ng-container>
    </div> -->

    <ng-template #noHistory>
      <div class="no-history">No chat history found</div>
    </ng-template>

    <ng-template #noHistory>
      <div class="empty-state" *ngIf="sidebarCollapsed">
        <span class="fa-solid fa-inbox"></span>
        <p>No conversations yet</p>
      </div>
    </ng-template>

    <div class="sidebar-footer">
      <button
        class="footer-btn"
        *ngIf="!isSidebarExpanded()"
        (click)="goToProfile()"
        title="Profile">
        <span class="fa-solid fa-circle-user"
          style="color: #facc15; font-size:20px"></span>
      </button>

      <button
        class="footer-btn"
        *ngIf="isSidebarExpanded()"
        (click)="goToProfile()"
        title="Profile">
        <span class="fa-solid fa-circle-user"
          style="color: #facc15; font-size:20px"></span>
        <span>Profile</span>
      </button>

      <!-- <button class="footer-btn" title="Settings">
        <span class="fa-solid fa-cog"></span>
        <span *ngIf="!sidebarCollapsed">Settings</span>
      </button> -->
    </div>
  </aside>

  <!-- Main Chat Area -->
  <main class="chat-main">

    <div class="message-container">
      <!-- <button
        class="chat-sidebar-btn mobile-only"
        (click)="toggleChatSidebar($event)"
        aria-label="Open chat sidebar">
        <img src="assets/sidebar.png" alt="Open Sidebar" />
      </button> -->
      <!-- Messages Container -->
      <div class="messages-container" #scrollArea>
        <ng-container
          *ngIf="hasActiveConversation || isUploading || isLoadingChat || messages().length; else welcomeScreen">
          <div *ngFor="let msg of messages(); trackBy: trackById"
            class="message-wrapper"
            [class.user-message]="msg.role === 'user'"
            [class.assistant-message]="msg.role === 'assistant'">

            <div class="message-content">
              <div class="avatar">
                <span class="fa-solid"
                  [ngClass]="msg.role === 'user' ? 'fa-user' : 'fa-robot'"></span>
              </div>

              <div class="message-body">
                <!-- <div class="message-text" *ngIf="msg.text">{{ msg.text
                }}</div> -->

                <div class="message-images" *ngIf="msg.images?.length">
                  <img *ngFor="let img of msg.images" [src]="img" alt="Image"
                    class="message-image"
                    (click)="selectImage(img, $event)" />
                </div>
                <div
                  class="message-description-text"
                  *ngIf="msg.text">
                  {{ msg.text
                  }}
                </div>
                <div class="message-meta" *ngIf="msg.room || msg.style">
                  <span class="meta-tag" *ngIf="msg.room">
                    <span class="fa-solid fa-door-open"></span> {{ msg.room }}
                  </span>
                  <span class="meta-tag" *ngIf="msg.style">
                    <span class="fa-solid fa-palette"></span> {{ msg.style }}
                  </span>
                </div>

                <div class="message-time">{{ msg.timestamp | date:'short'
                  }}</div>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-template #welcomeScreen>
          <div *ngIf="!hasActiveConversation" class="welcome-screen">
            <div class="welcome-icon">
              <span class="fa-solid fa-comments"></span>
            </div>
            <h2>Welcome to Beyanco AI Chat</h2>
            <p>Upload an image, select a room, and describe your vision. Our AI
              will bring it to life.</p>

            <div class="quick-actions">
              <button class="quick-action-btn" (click)="openUploadPopup()">
                <span class="fa-solid fa-upload"></span>
                <span>Upload Image</span>
              </button>
              <!-- <button class="quick-action-btn" (click)="openUploadPopup()">
                <span class="fa-solid fa-home"></span>
                <span>Select Room</span>
              </button> -->
            </div>
          </div>
        </ng-template>

      </div>
      <!-- Generated Property Chat Messages -->
      <!-- <div class="messages-container-generated" *ngIf="properties.length > 0">
        <ng-container>
          <div *ngFor="let p of properties">

            <div class="message-wrapper user-message">
              <div class="message-content">
                <div class="avatar">
                  <span class="fa-solid fa-user"></span>
                </div>

                <div class="message-body">

                  <div class="message-images" *ngIf="p.originalImageUrl">
                    <img [src]="p.originalImageUrl" alt="Original Design"
                      class="message-image"
                      (click)="selectImage(p.originalImageUrl, $event)" />
                  </div>
                  <div
                    class="message-title"
                    *ngIf="p.title">
                    {{ p.title }}
                  </div>
                  <div class="message-meta">
                    <span class="meta-tag">
                      <span class="fa-solid fa-door-open"></span> {{
                      p.propertyType }}
                    </span>
                    <span class="meta-tag" *ngIf="p.enhancementStyle">
                      <span class="fa-solid fa-palette"></span> {{
                      p.enhancementStyle }}
                    </span>
                  </div>

                  <div class="message-time">
                    {{ p.createdAt | date:'short' }}
                  </div>
                </div>
              </div>
            </div>

            <div class="message-wrapper assistant-message">
              <div class="message-content">
                <div class="avatar">
                  <span class="fa-solid fa-robot"></span>
                </div>

                <div class="message-body">
                  <div class="message-text">
                    Generated Design for <strong>{{ p.propertyType }}</strong>
                  </div>
                  <div class="message-images" *ngIf="p.generatedImageUrl">
                    <img [src]="p.generatedImageUrl" alt="Generated Design"
                      class="message-image"
                      (click)="selectImage(p.generatedImageUrl, $event)" />
                  </div>
                  <div
                    class="message-description"
                    *ngIf="p.description">
                    {{ p.description }}
                  </div>
                  <div class="message-meta">
                    <span class="meta-tag">
                      <span class="fa-solid fa-door-open"></span> {{
                      p.propertyType }}
                    </span>
                    <span class="meta-tag" *ngIf="p.enhancementStyle">
                      <span class="fa-solid fa-palette"></span> {{
                      p.enhancementStyle }}
                    </span>
                  </div>

                  <div class="message-time">
                    {{ p.createdAt | date:'short' }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div> -->

      <div class="loading-indicator" *ngIf="isUploading">
        <div class="spinner"></div>
        <span>Generating your design...</span>
      </div>
    </div>
    <!-- Input Composer -->
    <div class="composer-container">
      <div class="composer-wrapper">

        <div class="composer-input">

          <!-- Image preview (LEFT of textarea) -->
          <div class="inline-image-preview" *ngIf="pendingImages().length">
            <img [src]="pendingImages()[0]" />
            <button class="remove-img" (click)="removePendingImage(0)">
              ✕
            </button>
          </div>

          <!-- Textarea -->
          <textarea
            [(ngModel)]="composerDescription"
            class="composer-textarea"
            placeholder="Describe your vision..."
            rows="1"
            (keydown)="onEnterKey($event)"
            #textareaRef>
      </textarea>

          <!-- Actions -->
          <div class="composer-actions">

            <!-- ➕ Add button -->
            <button class="action-btn" (click)="toggleAddMenu($event)">
              <img src="assets/add-button.png" class="add-btn" />
            </button>

            <!-- Add menu -->
            <div class="add-menu" *ngIf="showAddMenu">
              <button (click)="triggerFileInput()">
                <span class="fa-solid fa-image"></span> Add Photo
              </button>
            </div>

            <!-- Hidden file input -->
            <input
              #fileInput
              type="file"
              accept="image/*"
              hidden
              (change)="onFiles($event)" />

            <!-- Send -->
            <button
              class="action-btn send-btn"
              (click)="send()"
              [disabled]="!canSend()">
              <span class="fa-solid fa-paper-plane"></span>
            </button>

          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- Setup Popup -->
  <div class="modal-overlay" *ngIf="showPopup" (click)="closePopup()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Setup Your Project</h2>
        <button class="close-modal-btn" (click)="closePopup()">
          <span class="fa-solid fa-times"></span>
        </button>
      </div>

      <div class="modal-body">
        <!-- Upload Area -->
        <div class="upload-area" *ngIf="!pendingImages().length">
          <label class="upload-label">
            <span class="fa-solid fa-cloud-upload-alt"></span>
            <span>Click to upload or drag & drop</span>
            <small>PNG, JPG up to 10MB</small>
            <input type="file" accept="image/*" multiple
              (change)="onFiles($event)" hidden>
          </label>
        </div>

        <!-- Preview Grid -->
        <div class="preview-grid" *ngIf="pendingImages().length">
          <div class="preview-card"
            *ngFor="let img of pendingImages(); let i = index">
            <img [src]="img" alt="Preview">
            <button
              class="remove-btn"
              (mousedown)="$event.stopPropagation()"
              (click)="removeCompareImage(i, $event)">
            </button>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group half">
            <label>Room Type</label>
            <select [(ngModel)]="roomModel" class="form-select">
              <option value>Select room...</option>
              <option *ngFor="let room of rooms" [value]="room">{{ room
                }}</option>
            </select>
          </div>

          <div class="form-group half">
            <label>Style Theme</label>
            <select [(ngModel)]="style" class="form-select">
              <option value>Select style...</option>
              <option *ngFor="let s of StyleTags" [value]="s">{{ s }}</option>
            </select>
          </div>
        </div>

        <!-- <div class="form-group">
          <label>House Style</label>
          <select [(ngModel)]="Housestyle" class="form-select">
            <option value>Select house style...</option>
            <option *ngFor="let hs of HouseStyleTags" [value]="hs">{{ hs
              }}</option>
          </select>
        </div> -->

        <div class="form-group" style="margin: 0;">
          <label>Description</label>
          <textarea [(ngModel)]="popupDescription" class="form-textarea"
            placeholder="I want a mordern living room with ambient sunlight..."
            rows="3"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary"
          (click)="closePopup()">Cancel</button>
        <button class="btn btn-primary"
          (click)="confirmPopup()">Generate</button>
      </div>
    </div>
  </div>

  <!-- Image Viewer Modal -->
  <div class="modal-overlay" *ngIf="showImagePopup && currentImage"
    (mousedown)="closeImagePopup()">
    <div class="modal-content image-modal"
      (mousedown)="$event.stopPropagation()">
      <!-- Toolbar -->
      <div class="image-toolbar">
        <div class="toolbar-left">
          <!-- <button class="toolbar-btn" (click)="undo()" title="Undo">
            <span class="fa-solid fa-undo"></span>
          </button>
          <button class="toolbar-btn" (click)="redo()" title="Redo">
            <span class="fa-solid fa-redo"></span>
          </button> -->

          <select [(ngModel)]="selectedTool" (change)="openTool(selectedTool)"
            class="tool-select">
            <option value disabled hidden>Select</option>
            <option *ngFor="let tool of tools" [value]="tool">{{ tool
              }}</option>
          </select>
        </div>

        <div class="toolbar-right">
          <!-- <button class="toolbar-btn" (click)="likeImage()" title="Like">
            <span class="fa-solid fa-thumbs-up"></span>
          </button>
          <button class="toolbar-btn" (click)="dislikeImage()"
            title="Dislike">
            <span class="fa-solid fa-thumbs-down"></span>
          </button>
          <button class="toolbar-btn" (click)="downloadImage()"
            title="Download">
            <span class="fa-solid fa-download"></span>
          </button> -->
          <button class="toolbar-btn" (click)="shareImage()" title="Share">
            <span class="fa-solid fa-share-alt"></span>
          </button>
          <button class="toolbar-btn close-btn" (click)="closeImagePopup()">
            <span class="fa-solid fa-times"></span>
          </button>
        </div>
      </div>

      <!-- Tool Panels -->
      <div class="tool-panel" *ngIf="activeTool === 'Magic Eraser'">
        <h3><span class="fa-solid fa-eraser"></span> Magic Eraser</h3>
        <p>Remove unwanted objects and clean up your image automatically.</p>
        <div class="tool-actions">
          <button class="btn btn-primary" (click)="applyEraser()">
            <span class="fa-solid fa-magic"></span> Apply Magic Eraser
          </button>
          <!-- <button class="btn btn-secondary"
            (click)="closeTool()">Cancel</button> -->
        </div>
      </div>
      <div class="tool-panel" *ngIf="activeTool === 'Compare Version'">
        <h3><span class="fa-solid fa-columns"></span> Compare Images</h3>

        <!-- Thumbnail Strip with Load More -->
        <div class="thumbnail-strip">
          <div
            class="thumb mobile-hint"
            *ngFor="let img of visibleThumbnails; let i = index"
            [class.selected]="selectedCompareImage === img"
            [attr.draggable]="!isTouchDevice()"
            (mousedown)="$event.stopPropagation()"
            (dragstart)="!isTouchDevice() && onDragStart($event, img)"
            (click)="isTouchDevice() && selectCompareImage(img)">

            <img [src]="img" alt="Thumbnail" />

            <button
              class="remove-btn"
              (click)="removeCompareImage(i, $event)">
              <span class="fa-solid fa-times"></span>
            </button>
          </div>

          <div class="load-more"
            *ngIf="compareThumbnails().length > visibleThumbnails.length">
            <button (click)="loadMoreThumbnails()">Load More</button>
          </div>

          <div class="no-thumbs" *ngIf="compareThumbnails().length === 0">
            No images yet
          </div>
        </div>

        <!-- Dropdown for number of boxes -->
        <div class="compare-box-selector">
          <label style="margin: 0;">Number of comparison boxes:</label>
          <select class="dropdown-count" [(ngModel)]="numCompareBoxes">
            <option *ngFor="let n of [2,4,6]" [value]="n">{{n}}</option>
          </select>
        </div>
        <!-- Orientation buttons -->
        <div class="compare-mode-selector">
          <button class="mode-btn"
            [class.active]="compareMode === 'horizontal'"
            (click)="setCompareMode('horizontal')">
            <span class="fa-solid fa-grip-lines-vertical"></span> Horizontal
          </button>
          <button class="mode-btn" [class.active]="compareMode === 'vertical'"
            (click)="setCompareMode('vertical')">
            <span class="fa-solid fa-grip-lines"></span> Vertical
          </button>
        </div>
        <!-- Comparison Area -->
        <div class="comparison-container"
          [class.horizontal]="compareMode === 'horizontal'"
          [class.vertical]="compareMode === 'vertical'">

          <div
            class="comparison-side"
            *ngFor="let box of compareBoxes; let i = index"
            (mousedown)="$event.stopPropagation()"
            (click)="isTouchDevice() && placeCompareImage(i)"
            (dragover)="onDragOver($event)"
            (drop)="onDrop($event, i)">

            <div class="comparison-label">Box {{i+1}}</div>
            <img *ngIf="box" [src]="box" alt="Comparison" />
            <div class="no-image" *ngIf="!box">Drop image here</div>
          </div>
        </div>

        <!-- <div class="tool-actions">
          <button class="btn btn-secondary" (click)="closeTool()">Close</button>
        </div> -->
      </div>

      <!-- <div class="tool-panel" *ngIf="activeTool === 'Compare Version'">
        <h3><span class="fa-solid fa-columns"></span> Compare Images</h3>

        <div class="compare-mode-selector">
          <button class="mode-btn" [class.active]="compareMode === 'horizontal'" (click)="setCompareMode('horizontal')">
            <span class="fa-solid fa-grip-lines-vertical"></span> Horizontal
          </button>
          <button class="mode-btn" [class.active]="compareMode === 'vertical'" (click)="setCompareMode('vertical')">
            <span class="fa-solid fa-grip-lines"></span> Vertical
          </button>
        </div>

        <div class="comparison-container" [class.horizontal]="compareMode === 'horizontal'"
          [class.vertical]="compareMode === 'vertical'">
          <div class="comparison-side">
            <div class="comparison-label">Original</div>
            <img [src]="currentOriginalImage" *ngIf="currentOriginalImage" alt="Original">
            <div class="no-image" *ngIf="!currentOriginalImage">No original
              image</div>
          </div>
          <div class="comparison-side">
            <div class="comparison-label">Generated</div>
            <img [src]="currentGeneratedImage" *ngIf="currentGeneratedImage" alt="Generated">
            <div class="no-image" *ngIf="!currentGeneratedImage">No generated
              image</div>
          </div>
        </div>

        <div class="tool-actions">
          <button class="btn btn-secondary" (click)="closeTool()">Close</button>
        </div>
      </div> -->

      <div class="tool-panel" *ngIf="activeTool === 'Add Element'">
        <h3><span class="fa-solid fa-plus-circle"></span> Add Element</h3>
        <p>Select an element to enhance your design:</p>

        <div class="element-grid">
          <button *ngFor="let el of elements" class="element-card"
            [class.selected]="selectedElement === el.name"
            (click)="selectedElement = el.name">
            <span class="fa-solid fa-lightbulb"
              *ngIf="el.name === 'Add Lighting'"></span>
            <span class="fa-solid fa-leaf"
              *ngIf="el.name === 'Add Plants'"></span>
            <span class="fa-solid fa-couch"
              *ngIf="el.name === 'Add Furniture'"></span>
            <span class="fa-solid fa-image"
              *ngIf="el.name === 'Add Artwork'"></span>
            <span class="fa-solid fa-th-large"
              *ngIf="el.name === 'Add Rug'"></span>
            <span class="fa-solid fa-window-maximize"
              *ngIf="el.name === 'Add Curtains'"></span>
            <span>{{ el.name }}</span>
          </button>
        </div>

        <div class="element-description" *ngIf="selectedElement">
          <strong>Prompt:</strong> {{ getElementPrompt(selectedElement) }}
        </div>

        <div class="tool-actions">
          <button class="btn btn-primary" (click)="applyElement()"
            [disabled]="!selectedElement">
            <span class="fa-solid fa-check"></span> Apply Element
          </button>
          <!-- <button class="btn btn-secondary"
            (click)="closeTool()">Cancel</button> -->
        </div>
      </div>

      <!-- Image Display -->
      <div class="image-display" *ngIf="!activeTool">
        <img [src]="currentImage" alt="Full size preview">
      </div>
    </div>
  </div>
</div>
<!-- MOBILE FAB TOGGLE -->
<!-- <button
  class="mobile-fab"
  (click)="toggleMobileSidebar()"
  aria-label="Toggle Menu">
  <span class="fa-solid"
    [ngClass]="mobileSidebarOpen ? 'fa-xmark' : 'fa-comment'"></span>
</button> -->
<!-- BACKDROP -->
<div class="credit-backdrop" *ngIf="showCreditPopup"
  (click)="closeCreditPopup()">

  <!-- MODAL BOX -->
  <div class="credit-modal" (click)="$event.stopPropagation()">
    <h2>Credit Limit Reached</h2>
    <p>You have no credits left. Please upgrade your plan.</p>

    <button class="close-btn" (click)="closeCreditPopup()">Close</button>
  </div>

</div>

<div class="modal-backdrop" *ngIf="showRenameModal">
  <div class="modal-box">
    <h3>Rename Chat</h3>

    <input
      type="text" class="fo"
      [(ngModel)]="newChatName"
      placeholder="Enter chat name" />

    <div class="actions">
      <button class="btn cancel" (click)="cancelRename()">Cancel</button>
      <button class="btn primary" (click)="confirmRename()">Save</button>
    </div>
  </div>
</div>
<div class="modal-backdrop" *ngIf="showDeleteModal">
  <div class="modal-box">
    <h3>Delete Chat?</h3>
    <p>This action cannot be undone.</p>

    <div class="actions">
      <button class="btn cancel" (click)="cancelDelete()">No</button>
      <button class="btn danger" (click)="confirmDelete()">Yes,
        Delete</button>
    </div>
  </div>
</div>
