<div class="page" [class.sidebar-collapsed]="sidebarCollapsed">
  <aside class="sidebar" [class.collapsed]="sidebarCollapsed" [class.open]="mobileSidebarOpen">
    <div class="logo">
      <i class="far fa-comment"></i>
      <span *ngIf="!sidebarCollapsed">Beyanco Chat UI</span>
      <button class="collapse-btn" (click)="toggleSidebar()">
        <i class="fas" [ngClass]="sidebarCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'"></i>
      </button>
    </div>
    <button class="new-chat" (click)="newChat()"><i class="fas fa-plus"></i> New
      chat</button>
    <div class="divider"></div>
    <p class="history-Chats">Recent Chats</p>
    <div class="history" *ngIf="conversations().length; else noHist">
      <button *ngFor="let h of conversations(); trackBy: trackById" class="history-item"
        [class.active]="h.id === activeConversationId()" (click)="openConversation(h.id)">
        <div class="title ellipsis">{{ h.title }}</div>
        <div class="sub ellipsis">{{ h.preview }}</div>
      </button>
    </div>
    <ng-template #noHist>
      <div class="empty">No history yet</div>
    </ng-template>

    <div class="sidebar-footer">
      <div class="profile" (click)="goToProfile()">
        <i class="fas fa-user-circle"></i>
        <span>Profile</span>
      </div>
      <button class="settings-btn" title="Settings">
        <i class="fas fa-cog"></i>
      </button>
    </div>

  </aside>

  <!-- <aside class="sidebar">
    <div class="logo"><i class="far fa-comment"></i> Beyanco Chat UI</div>
    <button class="new-chat" (click)="newChat()"><i class="fas fa-plus"></i> New
      chat</button>
    <div class="divider"></div>
    <p class="history-Chats">Recent Chats</p>
    <div class="history" *ngIf="conversations().length; else noHist">
      <button
        *ngFor="let h of conversations(); trackBy: trackById"
        class="history-item"
        [class.active]="h.id === activeConversationId()"
        (click)="openConversation(h.id)">
        <div class="title ellipsis">{{ h.title }}</div>
        <div class="sub ellipsis">{{ h.preview }}</div>
      </button>
    </div>
    <ng-template #noHist>
      <div class="empty">No history yet</div>
    </ng-template>

    <div class="sidebar-footer">
      <div class="profile">
        <i class="fas fa-user-circle"></i>
        <span>Profile</span>
      </div>
      <button class="settings-btn" title="Settings">
        <i class="fas fa-cog"></i>
      </button>
    </div>
  </aside> -->

  <main class="chat">
    <div class="chat-header">
      <button class="hamburger-btn" (click)="toggleMobileSidebar()">
        <i class="fas fa-chevron-left"></i>
      </button>
      <div class="room-chip" *ngIf="room()">Room: {{ room() }}</div>
    </div>

    <!-- <div class="chat-header">
      <div class="room-chip" *ngIf="room()">Room: {{ room() }}</div>
    </div> -->

    <div class="messages" #scrollArea>
      <ng-container *ngIf="messages().length; else welcome">
        <div *ngFor="let m of messages(); trackBy: trackById" class="message" [class.user]="m.role==='user'"
          [class.assistant]="m.role==='assistant'">
          <div class="avatar" [ngClass]="m.role === 'user' ? 'user-avatar' : 'assistant-avatar'">
            <i class="fas" [ngClass]="m.role === 'user' ? 'fa-user' : 'fa-robot'"></i>
          </div>
          <div class="bubble">
            <ng-container *ngIf="m.images?.length">
              <div class="image-strip">
                <!-- <img *ngFor="let img of m.images" [src]="img" alt="uploaded" /> -->
                <img [src]="'http://localhost:8080' + m.images" alt="uploaded">
              </div>
            </ng-container>
            <div class="text" [innerText]="m.text"></div>
            <div class="meta" *ngIf="m.meta?.length">
              <span *ngFor="let tag of m.meta" class="tag">{{ tag }}</span>
            </div>
            <div class="time">{{ m.timestamp | date:'shortTime' }}</div>
          </div>
        </div>
      </ng-container>
      <ng-template #welcome>
        <div class="welcome">
          <h2>Welcome ðŸ‘‹</h2>
          <p>Ask anything. Upload an image, pick a room, and describe your task.
            Results will appear here in a ChatGPT-style thread. Images show
            above your description.</p>
        </div>
      </ng-template>
    </div>

    <div class="composer" (keydown.control.enter)="send()" (keydown.meta.enter)="send()">
      <div class="input-wrap">
        <textarea [(ngModel)]="description" class="textarea" placeholder="Describe your request..." rows="3"></textarea>

        <button class="icon-btn plus" (click)="toggleActionsMenu()" title="More actions"><i
            class="fas fa-plus"></i></button>

        <button class="icon-btn mic" [disabled]="recognizing()" (click)="startVoice()" title="Voice input">
          <i class="fas fa-microphone"></i>
        </button>
        <button class="icon-btn stop" *ngIf="recognizing()" (click)="stopVoice()" title="Stop recording"><i
            class="fas fa-stop"></i></button>
        <button class="icon-btn send" (click)="send()" title="Send">
          <i class="fas fa-paper-plane"></i>
        </button>
        <button class="icon-btn room" (click)="showPopup = true" title="Upload & Room">
          <i class="fas fa-sliders-h"></i>
        </button>

        <div class="menu" *ngIf="actionsOpen()">
          <button class="menu-item" (click)="toggleMeta('Add Photos')"><i class="fas fa-images"></i> Add
            Photos</button>
          <button class="menu-item" (click)="toggleMeta('Study & Learn')"><i class="fab fa-leanpub"></i>
            Study & Learn</button>
          <button class="menu-item" (click)="toggleMeta('Create Image')"><i class="fas fa-palette"></i>
            Create Image</button>
          <button class="menu-item" (click)="toggleMeta('Think Longer')"><i class="fa-solid fa-brain"></i>
            Think Longer</button>
        </div>
      </div>
    </div>
  </main>
  <!-- popup -->
  <div class="popup-backdrop" *ngIf="showPopup">
    <div class="popup-box">
      <div class="popup-header">
        <h2>Setup Chat</h2>
        <button class="close-btn" (click)="closePopup()">âœ•</button>
      </div>

      <label class="upload-box" *ngIf="pendingImages().length === 0">
        <i class="fas fa-cloud-upload-alt upload-icon"></i>
        <span class="upload-text">
          Click to upload <br />
          <small>or drag & drop</small>
        </span>
        <input type="file" accept="image/*" multiple (change)="onFiles($event)" />
      </label>

      <!-- Preview uploaded images -->
      <div class="preview-container">
        <div class="preview" *ngFor="let img of pendingImages()">
          <img [src]="img" alt="Uploaded image preview" />
        </div>
      </div>


      <label class="field">
        <span class="label">Select room</span>
        <select [(ngModel)]="roomModel">
          <option [ngValue]="''">â€” None â€”</option>
          <option *ngFor="let r of rooms" [ngValue]="r">{{ r }}</option>
        </select>
      </label>
      <label class="field">
        <span class="label">Select Theme</span>
        <select [(ngModel)]="style">
          <option [ngValue]="''">â€” None â€”</option>
          <option *ngFor="let r of StyleTags" [ngValue]="r">{{ r }}</option>
        </select>
      </label>
      <label class="field">
        <span class="label">Description</span>
        <textarea [(ngModel)]="description" class="textarea" placeholder="Describe your request..." rows="1"></textarea>
      </label>
      <div class="d-flex">
        <button class="confirm-btn" (click)="confirmPopup()">Start Chat</button>
      </div>

    </div>
  </div>

  <!-- <aside class="right">
    <button class="right-popup-btn" (click)="showPopup = true"
      title="Upload & Room">
      <i class="fas fa-sliders-h"></i>
    </button>
  </aside> -->
  <!-- <aside class="right">
    <div class="panel">
      <span class="label">Upload image</span>
      <label class="upload-box">
        <i class="fas fa-cloud-upload-alt upload-icon"></i>
        <span class="upload-text">
          Click to upload <br />
          <small>or drag and drop</small>
        </span>
        <input type="file" accept="image/*" multiple
          (change)="onFiles($event)" />
      </label>

      <label class="field">
        <span class="label">Select room</span>
        <select [(ngModel)]="roomModel">
          <option [ngValue]="''">â€” None â€”</option>
          <option *ngFor="let r of rooms" [ngValue]="r">{{ r }}</option>
        </select>
      </label>

      <div class="thumbs" *ngIf="pendingImages().length">
        <div class="thumb" *ngFor="let img of pendingImages(); let i = index">
          <img [src]="img" alt="preview" />
          <button class="remove" (click)="removePendingImage(i)"
            title="Remove">âœ•</button>
        </div>
      </div>

      <div class="chips" *ngIf="chosenMeta().length">
        <span class="chip" *ngFor="let m of chosenMeta()"
          (click)="toggleMeta(m)">{{ m }} âœ•</span>
      </div>

      <div class="hint">Tip: Press Ctrl/Cmd + Enter to send</div>
    </div>
  </aside> -->
</div>